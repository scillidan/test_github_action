name: Test Custom Docset Generation

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test-docset:
    runs-on: ubuntu-latest

    outputs:
      latest_version: ${{ steps.get_version.outputs.version }}
      should_release: ${{ steps.check_version.outputs.should_release }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get latest Requests version
      id: get_version
      run: |
        version=$(curl -s "https://api.github.com/repos/psf/requests/releases/latest" | python3 -c "import sys, json; print(json.load(sys.stdin)['tag_name'].lstrip('v'))")
        echo "version=$version" >> $GITHUB_OUTPUT

    - name: Check if version tag already exists
      id: check_version
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VERSION: ${{ steps.get_version.outputs.version }}
        REPO: ${{ github.repository }}
      run: |
        version="$VERSION"
        status=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $GH_TOKEN" \
          "https://api.github.com/repos/$REPO/releases/tags/v${version}")
        if [ "$status" = "200" ]; then
          echo "should_release=false" >> $GITHUB_OUTPUT
          echo "Release v$version already exists in $REPO, skipping..."
        else
          echo "should_release=true" >> $GITHUB_OUTPUT
        fi

    - name: Set up Python
      if: ${{ steps.check_version.outputs.should_release == 'true' }}
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      if: ${{ steps.check_version.outputs.should_release == 'true' }}
      run: |
        pip install beautifulsoup4 lxml

    - name: Download source
      if: ${{ steps.check_version.outputs.should_release == 'true' }}
      env:
        VERSION: ${{ steps.get_version.outputs.version }}
      run: |
        version="$VERSION"
        curl -L -o source.zip "https://github.com/psf/requests/archive/refs/tags/v${version}.zip"
        unzip -q source.zip

    - name: Build documentation
      if: ${{ steps.check_version.outputs.should_release == 'true' }}
      run: |
        cd requests-*/docs
        make html
        cd ../..

    - name: Move HTML to expected location
      if: ${{ steps.check_version.outputs.should_release == 'true' }}
      env:
        VERSION: ${{ steps.get_version.outputs.version }}
      run: |
        version="$VERSION"
        mv requests-$version/docs/_build/html _html

    - name: Generate docset with custom script
      if: ${{ steps.check_version.outputs.should_release == 'true' }}
      run: |
        python requests_to_docset.py --html-dir _html --version "${{ steps.get_version.outputs.version }}"

    - name: List generated files
      if: ${{ steps.check_version.outputs.should_release == 'true' }}
      run: |
        ls -la *.tgz 2>/dev/null || echo "No tgz files found"

    - name: Upload artifact for inspection
      if: ${{ steps.check_version.outputs.should_release == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: requests-docset
        path: "*.tgz"

    - name: Create GitHub Release and upload files
      if: ${{ steps.check_version.outputs.should_release == 'true' }}
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: "${{ steps.get_version.outputs.version }}"
        files: |
          *.tgz
